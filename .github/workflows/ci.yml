# .github/workflows/ci.yml
# CI Pipeline: Lint, Validate Notebooks
#
# ãƒˆãƒªã‚¬ãƒ¼:
# - main/developãƒ–ãƒ©ãƒ³ãƒã¸ã®push
# - Pull Request
# - æ‰‹å‹•å®Ÿè¡Œï¼ˆworkflow_dispatchï¼‰

name: CI

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
  workflow_dispatch:

# åŒä¸€ãƒ–ãƒ©ãƒ³ãƒã§ã®é‡è¤‡å®Ÿè¡Œã‚’é˜²ã
concurrency:
  group: ci-${{ github.ref }}
  cancel-in-progress: true

env:
  PYTHON_VERSION: "3.12"
  UV_SYSTEM_PYTHON: 1

jobs:
  # ============================================================
  # Lint Job: Ruff ã«ã‚ˆã‚‹é™çš„è§£æ
  # ============================================================
  lint:
    name: ğŸ” Lint (Ruff)
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: ğŸ Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: ğŸš€ Install uv
        uses: astral-sh/setup-uv@v5

      - name: ğŸ“¦ Install dependencies
        run: |
          uv sync

      - name: ğŸ” Run Ruff linter
        run: |
          uv run ruff check --output-format=github .

      - name: ğŸ¨ Run Ruff formatter (check mode)
        run: |
          uv run ruff format --check .

  # ============================================================
  # Notebook Validation: marimo ãƒãƒ¼ãƒˆãƒ–ãƒƒã‚¯ã®æ§‹æ–‡ãƒã‚§ãƒƒã‚¯
  # ============================================================
  validate-notebooks:
    name: ğŸ““ Validate Notebooks
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: ğŸ Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: ğŸš€ Install uv
        uses: astral-sh/setup-uv@v5

      - name: ğŸ“¦ Install dependencies
        run: |
          uv sync

      - name: ğŸ““ Validate marimo notebooks syntax
        run: |
          # marimoãƒãƒ¼ãƒˆãƒ–ãƒƒã‚¯ãŒPythonã¨ã—ã¦æœ‰åŠ¹ã‹ãƒã‚§ãƒƒã‚¯
          for notebook in notebooks/*.py; do
            echo "Validating $notebook..."
            uv run python -m py_compile "$notebook"
          done

      - name: ğŸ” Check notebooks with Ruff
        run: |
          uv run ruff check notebooks/
